---
params:
  icao: "XXXX"
  iata: "YYY"
  name: "airport name"
  state: "state name"
  config: !r mtcars
  ldgsum: !r mtcars
  latest: !r mtcars
  covid: !r mtcars
  tfc: !r mtcars
  thru: !r mtcars
  atfm: !r mtcars
  slot: !r mtcars
  asma: !r mtcars
  txot: !r mtcars
  txit: !r mtcars
  pddly: !r mtcars
  turn: !r mtcars
  punc: !r mtcars
title: "`r params$icao`"
author: "AIU Home"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows # columns
    logo: "euctrl-logo-noname_48x48.png"
  #  logo: ECTRL-logo.png
  #  navbar:
  #    - { icon: "fa-question-circle", href: "https://google.com", align: right }
    #vertical_layout: scroll # fill # forces filled page (not good for multiple charts)
    # speeding up plotly --> https://www.timlrx.com/2019/12/17/speeding-up-r-plotly-webapps-r-x-javascript-part-i/
  #  mathjax: NULL          # no math symbols/equations used
    self_contained: TRUE # FALSE  # do not include plotly libs in html output
---

<script>
$('.navbar-logo').wrap('<a href="http://www.eurocontrol.int">');
$('.navbar-author').wrap('<a href="http://ansperformance.eu">');
</script>

<style>
.navbar-author {
  color: white;
}
</style>

<!-- div style="position:absolute;top:0px;right:0px;" -->
<!-- img src="ECTRL-logo.svg"/ -->
<!-- /div -->

```{r setup, include=FALSE}
library(flexdashboard)
library(DT)
library(ggplot2)
library(dplyr)
library(tidyr)
library(plotly)
library(magick)
```
```{r plotly-utility}
tick_yr <- list(dtick = 1
    ,ticktext = list("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")
    ,tickvals = list(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12)
    ,tickmode = "array"
    ,range = c(0.5,12.5))
tick_yr_no_title <- list(
   title = ""
  ,dtick = 1
  ,ticktext = list("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")
  ,tickvals = list(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12)
  ,tickmode = "array"
  ,range = c(0.5,12.5))

pick_mth <- c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")

# for logo remove set in config(showlogo = FALSE)!
config_bar_remove_buttons <- c(
              'sendDataToCloud' # 'toImage',
             ,'autoScale2d'  # 'resetScale2d',
             ,"select2d"     # box select   
             ,'lasso2d', 'pan2d'
            ,'zoom2d','zoomIn2d', 'zoomOut2d', 'zoomInGeo', 'zoomOutGeo',
             'hoverClosestCartesian','hoverCompareCartesian','toggleSpikelines'
            ,'drawrect')
```



# Overview {data-icon="fa-home"}

## Row ----------------------------------------------------------

### Aerodrome Layout

```{r}
filename <- paste("data-ad-charts/", params$icao, ".png", sep="") 
ad_chart <- magick::image_read(filename)
if(params$icao %in% c("EHAM", "LEMD", "LSZH")){
  angle <- 300
  ad_chart <- ad_chart %>% magick::image_rotate(angle)
}
ad_chart %>% image_trim()
```

### General

```{r apt-id}
id_tbl <- tribble(
   ~ITEM       , ~TEXT1       , ~TEXT2
  ,"Airport"   , params$name  , ""
  ,"ICAO/IATA" , paste0(params$icao, "/", params$iata) , ""
  ,"State"     , params$state , ""
  ,""          ,""            , ""
)

rwy_config <- params$config %>%
  mutate(ITEM = "") %>%
  select(ITEM, TEXT1 = CONFIGURATION, TEXT2 = SHARE_PCT ) %>%
  mutate(TEXT2 = paste0(round( 100 * TEXT2) , "%")) %>%   # no digit
  na.omit()
rwy_config$ITEM[1] <- "Configurations in 2019"

rwy_config_footer <- data.frame(
  ITEM = "", TEXT1 = ""
)

id_tbl <- id_tbl %>% bind_rows(rwy_config)

# a way to include footnote into DT: https://rstudio.github.io/DT/
# went in the end for the caption variant.
#
# sketch <- htmltools::withTags(table(
#    tableHeader(id_tbl),
#    tableFooter("Only configurations with a minimum of 3% share are shown.")
#))

id_tbl %>%
  datatable(
 #   container = sketch,   # added for footnote
     options = list( # ---------------------------------
         dom             = "t"        # show only table)
      ,  ordering        = FALSE      # no order arrows/functionality
      ,  autoWidth = TRUE
      , columnDefs = list(list(width = '150px', targets = c(0))) # set 1st col
      , scrollX = TRUE
    ) # end options list ------------------------------
    # remove table header and order arrows ~ overwrite with empty names
    , colnames  = rep("", ncol(id_tbl)) 
   # , class="compact cell-border"      # removes cell(-col) padding 
    , rownames  = FALSE
    , selection = 'none'
   # footnote ------------------------------------------
    , caption = htmltools::tags$caption(
             style = 'caption-side: bottom; text-align: right;'
            ,'Only configurations with a minimum of 3% share are shown.'
            ) # ----------------------------------------
    ) %>%
  formatStyle(names(id_tbl),lineHeight='70%') #sets "format" of specified columns (here all) 

```

## Row ----------------------------------------------------------

### Summary

```{r front-page-table}
source("./R/prepare_frontpage_DT_Rel1.R")

out <- prepare_front_page_DT(params$icao, params$tfc, params$asma, params$txot, params$atfm
                             , params$ldgsum, params$latest)

out %>% 
  datatable(
      options = list(
        dom             = "t"        # show only table
        ,pageLength     = nrow(out)  # number of rows shown
        ,ordering       = FALSE      # no order arrows/functionality
        ,columnDefs     = list(list(className = 'dt-center'
                                    , targets = "_all" ))  # or targets = 0:4
          # widget callback for sparkline
          ,fnDrawCallback = htmlwidgets::JS('function(){
                                  HTMLWidgets.staticRender();  }' )
          ) #end options
      ,escape = FALSE      # set escape to FALSE for htmlwidget/sparkline
      ,colnames   = c("Indicator","Year 2019"  # REL1 FIX, "% Change <br>Previous Month"
                       ,"Most Recent Month","12-month Trend")
      , rownames  = FALSE
    # footnote ------------------------------------------
      , caption = htmltools::tags$caption(
             style = 'caption-side: bottom; text-align: right;'
            ,'Performance measures (other than traffic) are typically reported for the month preceeding the previous month, i.e. July -> May. Data reported under Most Recent Month dating back further point at on-going quality validation or missing reporting.'
            ) # ----------------------------------------
      ) %>% 
  spk_add_deps() 
  
  #%>%       # add sparkline dependencies
  #formatPercentage(
  #  3, 2    # format 3rd column as % and 2 digits
  #  )
```

### COVID19 Snapshot Traffic Evolution (Movements and Percentage Change 2020 vs 2019)

```{r covid-snapshot, results='asis'}
if(nrow(params$covid) < 1){
  cat("<p><b>COVID19 traffic evolution for this airport under development!</b>")
}else{
  
fig1 <- params$covid %>% 
  plot_ly() %>%
  add_lines(x=~DAY, y=~FLTS_2020, name = "Movements 2020") %>%
  add_lines(x=~DAY, y=~FLTS_2019, name = "Movements 2019"
            , line = list(dash = "dot", color = "red")) %>%
  layout(yaxis = list(title = "movements"))

fig2 <- params$covid %>% 
  plot_ly() %>%
  add_lines(x=~DAY, y=~MOV_AVG_WK, name = "Moving Weekly Average", showlegend=FALSE) %>% 
  layout( xaxis = list(title = "") 
         ,yaxis = list(title = "% change from 2019"
                      ,titlefont = list(size = 11)
                      ,tickformat = "%"))

fig <- subplot(fig1, fig2, nrows=2, shareX = TRUE) %>%
  layout( hovermode = "x unified") %>%
  config( displaylogo = FALSE
         ,modeBarButtonsToRemove = config_bar_remove_buttons
           )
fig
}
```


# Traffic

## Row ----------------------------------------------------------

### Annual Traffic

<!-- REMOVED YTD
# annotation - ytd
mvts_thisyear = params$tfc %>% filter(YEAR == max(YEAR))
mvts_jan = mvts_thisyear %>% filter(MONTH_NUM == "01") %>% 
  summarise(FLT_TOT = sum(FLT_TOT_1, na.rm = TRUE))
max_mth  <- max(mvts_thisyear$MONTH_NUM)
mvts_last<- mvts_thisyear %>% filter(MONTH_NUM == max_mth) %>%
  summarise(FLT_TOT = sum(FLT_TOT_1, na.rm = TRUE))
mvts_ytd <- (mvts_last - mvts_jan) / mvts_jan
-->

```{r}
# annual bar chart
mvts_pa <- params$tfc %>% select(YEAR, FLT_TOT_1 ) %>%
  group_by(YEAR) %>%
  summarise(FLT_TOT = sum(FLT_TOT_1, na.rm = TRUE)) %>% ungroup()

cum_mvts <- params$tfc %>% 
  select(YEAR, MONTH_NUM, FLT_DATE, FLT_TOT_1) %>% 
  mutate(across(c(YEAR,MONTH_NUM), as.numeric)) %>% 
  filter(YEAR %in% c(max(YEAR), max(YEAR)-1))

this_year_max_month <- cum_mvts %>% filter(YEAR == max(YEAR)) %>% 
  pull(MONTH_NUM) %>% max() %>% unique()

cum_mvts <- cum_mvts %>% filter(MONTH_NUM <= this_year_max_month) %>% 
  group_by(YEAR) %>% 
  summarise(FLT_TOT_1 = sum(FLT_TOT_1, na.rm = TRUE)) %>% 
  mutate(CHANGE = ( FLT_TOT_1 - lag(FLT_TOT_1))/lag(FLT_TOT_1) )

msg     <- paste0( "<b>Change Jan-", pick_mth[this_year_max_month],"<br>"
                  , cum_mvts$YEAR[2]," vs ", cum_mvts$YEAR[1]
                  , ":<br>", round(100* cum_mvts[2,"CHANGE"], 2),"% </b>")

msg_y   <- mvts_pa %>% 
  filter(YEAR == as.integer(max(YEAR)) - 1) %>% 
  mutate(FLT_TOT = 0.7 * FLT_TOT) %>% pull(FLT_TOT)
key_msg <- list(x = unique(max(mvts_pa$YEAR)), y = msg_y
                ,text = msg
                ,size = 14
                ,showarrow = FALSE)

# experiment with other font
# deactivated 
# font <- list(family = "Courier New, monospace", size = 18, color = "#7f7f7f")
xax <- list(title="")
# yax <- list(title="Number of flights", titlefont = font)
yax <- list(title="Number of flights", titlefont = list(size = 11))

mvts_pa %>%
  plot_ly(x = ~YEAR, y = ~FLT_TOT) %>%
  add_trace(type = "bar", name = "Traffic"
            ,hoverinfo = "text"
            ,hovertemplate = paste(
               "Year: %{x}"
              ,"<br>Flights: %{y}" 
            )) %>% 
  layout(xaxis = xax, yaxis = yax # autosize = F, width = 300, height = 300
         ,annotations = key_msg
    ) %>%                    
config( displaylogo = FALSE
         ,modeBarButtonsToRemove = config_bar_remove_buttons
           )
```

### Annual Variation of Daily Movements 
<!-- add this behind header to size box {data-width=300} -->

```{r}
tmp <- params$tfc %>%
  select(YEAR, DATE = FLT_DATE, FLT_DEP_1, FLT_ARR_1) %>%
  pivot_longer(cols = starts_with("FLT_"), names_to = "PHASE", values_to = "MVTS") %>%
  separate(PHASE, into = c(NA, "PHASE", NA), sep = "_")

xax <- list(title = "")
yax <- list(title = "Movements per day",titlefont = list(size = 11))

pbox_group <- tmp %>%
  plot_ly(x = ~YEAR, y = ~MVTS, color = ~PHASE, type = "box") %>%
  layout(boxmode = "group", xaxis=xax, yaxis=yax) %>%
  config( displaylogo = FALSE
         ,modeBarButtonsToRemove = config_bar_remove_buttons)
pbox_group
```

## Row -----------------------------------------------------------

### Monthly Traffic

```{r}
# monthly trend
mvts_pm <- params$tfc %>% select(YEAR, MONTH_NUM, FLT_TOT_1) %>%
  group_by(YEAR, MONTH_NUM) %>%
  summarise(FLT_TOT = sum(FLT_TOT_1, na.rm = TRUE)) %>% ungroup()

# annotation - highlight highest monthly traffic in the last years
mvts_pm_max <- mvts_pm %>% filter(FLT_TOT == max(FLT_TOT))

msg         <- paste0( "<b>Busiest month <br>(last 5 years): <br>"
                      ,mvts_pm_max$MONTH_NUM, "-", mvts_pm_max$YEAR
                      ,"<br>", mvts_pm_max$FLT_TOT, "</b>")

# replaced with add_annotations - c.f. below
#key_msg     <- list( text = msg
#                    , x   = mvts_pm_max$MONTH_NUM
#                    , y   = mvts_pm_max$FLT_TOT 
#                    , showarrow = TRUE)

# plot
xax <- tick_yr_no_title
yax <- list(title="Number of flights", rangemode = "tozero",titlefont = list(size = 11))

mvts_pm %>%
  plot_ly(x = ~MONTH_NUM, y = ~FLT_TOT, group = ~YEAR, color = ~YEAR) %>%
  add_trace( type = 'scatter', mode = 'markers+lines'
             ) %>%
  add_annotations( text = msg
                  , x = mvts_pm_max$MONTH_NUM
                  , y = mvts_pm_max$FLT_TOT
                  , showarrow = TRUE, ax = 50, ay = 100) %>%
  layout( xaxis = xax, yaxis=yax
          ,hovermode = "x unified"
        # ,annotations = key_msg
           )  %>%       #layout(autosize = F, width = 300, height = 300)
  config( displaylogo = FALSE
         ,modeBarButtonsToRemove = config_bar_remove_buttons
           )
```

### Average Weekday Hourly Throughput

```{r}
thru <- params$thru %>% 
  filter(TIME >= hm("05:55"), TIME <= hm("23:05"))

thru_yr <- unique(thru$YEAR)
thru_mth<- unique(thru$MONTH_NUM)
 
thru_tot <- thru %>% group_by(TIME) %>% 
  summarise(ROLLING_HOUR_MVT = sum(ROLLING_HOUR_MVT, na.rm = TRUE)) %>% 
  mutate(PHASE="TOT") %>% ungroup()

thru <- thru %>% bind_rows(thru_tot) %>%
  mutate( TIME = as.character(TIME)
         ,TIME = strtrim(TIME, 5))
#  mutate(TIME = lubridate::hm(TIME))
# TIME seems to be turned to string!!!!, i.e. time formatting does not work!!!

#xax = list(title= "", type = 'time', tickformat = "%H%M") # 
xax = list( title="", type = "category" ,range = c("06:00","23:00")) #
yax = list( title= 'Average throughput [flights/hour]'
           ,titlefont = list(size = 11)
           ,hoverformat = ".2f")

msg = paste0("<b>Average 15-min rolling hour",
             "<br>throughput-weekdays month ", pick_mth[thru_mth],"</b>")

if(max(thru$ROLLING_HOUR_MVT) <= 20){
  msg_y <- 1.2 * max(thru$ROLLING_HOUR_MVT)
}else{
  msg_y <- 0.1 * max(thru$ROLLING_HOUR_MVT)
}

thru %>% 
  plot_ly(x = ~TIME, y = ~ROLLING_HOUR_MVT, color = ~PHASE) %>%
  group_by(PHASE) %>%
  add_lines(type = 'scatter') %>%    
  add_annotations(text = msg
                 , x = 0.5, xref = "paper"       #"12:00"
                 , y = msg_y  
                 , showarrow = FALSE, ax = 0, ay = 0  # no arrow, no offset
                 , align = "center"
                 ) %>%
  layout( xaxis = xax, yaxis = yax
         ,hovermode = "x unified") %>%
  config( displaylogo = FALSE
         ,modeBarButtonsToRemove = config_bar_remove_buttons)
```


# ATFM

## Row -----------------------------------------------------------

### Annual Arrival ATFM Delay

```{r atfm_pa}
atfm_pa <- params$atfm %>% 
  select(YEAR, FLT_ARR_1, DLY_APT_ARR_1, AD_DISRUPTION, AD_CAPACITY, AD_WEATHER
         , AD_DISRUPTION_ATC, AD_CAPACITY_ATC, AD_STAFFING_ATC, AD_EVENTS
         ) %>%
  group_by(YEAR) %>%
  summarise( FLT_ARR_TOT     = sum(FLT_ARR_1,     na.rm = TRUE)
            ,DLY_APT_ARR_TOT = sum(DLY_APT_ARR_1, na.rm = TRUE)
            ,AD_DISRUPTION   = sum(AD_DISRUPTION, na.rm = TRUE)
            ,AD_CAPACITY     = sum(AD_CAPACITY,   na.rm = TRUE)
            ,AD_WEATHER      = sum(AD_WEATHER,    na.rm = TRUE)
            ,AD_DISRUPTION_ATC=sum(AD_DISRUPTION_ATC, na.rm = TRUE)
            ,AD_CAPACITY_ATC = sum(AD_CAPACITY_ATC, na.rm = TRUE)
            ,AD_STAFFING_ATC = sum(AD_STAFFING_ATC, na.rm = TRUE)
            ,AD_EVENTS       = sum(AD_EVENTS,     na.rm = TRUE)
            ) %>% ungroup() %>% 
  tidyr::pivot_longer(cols = starts_with("AD_"), names_to = "REG_REASON", values_to = "DLY") %>%
  mutate(AVG_ARR_ATFM_DLY = DLY_APT_ARR_TOT / FLT_ARR_TOT
         ,AVG_ARR_ATFM_REG= DLY / FLT_ARR_TOT)

# ------------------ ATFM Grouping and Colour Definition ------------------
atfm_col <- c(
   "#595959"    # rgb2hex(89,89,89)    # AD Events
  ,"#B9CDE5"    # rgb2hex(185,205,229) # AD Disruption
  ,"#E6B9B8"    # rgb2hex(230,185,184) # AD Capacity
  ,"#9BBB59"    # rgb2hex(155,187,89)  # AD Weather
  ,"#4F81BD"    # rgb2hex(79,129,189)  # AD Disruption ATC
  ,"#F79646"    # rgb2hex(247,150,70)  # Staffing ATC
  ,"#C0504D"    # rgb2hex(192,80,77)   # AD Capacity ATC
)
atfm_grps <- c("AD_EVENTS","AD_DISRUPTION","AD_CAPACITY","AD_WEATHER","AD_DISRUPTION_ATC","AD_STAFFING_ATC","AD_CAPACITY_ATC")
atfm_lbl <- c("Events","Disruption","Capacity", "Weather", "Disruption (ATC)","Staffing (ATC)", "Capacity (ATC)")

# -------------------------------------------------------------------------

atfm_pa <- atfm_pa %>% 
  mutate(REG_REASON = factor(REG_REASON, levels = atfm_grps, labels = atfm_lbl))

atfm_pa %>% 
  plot_ly( x = ~YEAR, y = ~AVG_ARR_ATFM_REG
          ,color = ~REG_REASON, colors = atfm_col
          , type = "bar") %>%
  layout(barmode = "stack"
         , hovermode = "x unified"
         , xaxis = list(title = "")
         , yaxis = list(title="Average arrival ATFM delay [min/arr]"
                        ,titlefont = list(size = 11))
         ) %>% 
config( displaylogo = FALSE
       ,modeBarButtonsToRemove = config_bar_remove_buttons)
```

### Monthly Arrival ATFM Delay

```{r}
# monthly trend
atfm_pm <- params$atfm %>% 
  #filter(YEAR == max(YEAR)) %>%
  select(YEAR, MONTH_NUM, FLT_ARR_1, DLY_APT_ARR_1, AD_DISRUPTION, AD_CAPACITY, AD_WEATHER
         , AD_DISRUPTION_ATC, AD_CAPACITY_ATC, AD_STAFFING_ATC, AD_EVENTS
         ) %>%
  group_by(YEAR, MONTH_NUM) %>%
  summarise( FLT_ARR_TOT     = sum(FLT_ARR_1,     na.rm = TRUE)
            ,DLY_APT_ARR_TOT = sum(DLY_APT_ARR_1, na.rm = TRUE)
            ,AD_DISRUPTION   = sum(AD_DISRUPTION, na.rm = TRUE)
            ,AD_CAPACITY     = sum(AD_CAPACITY,   na.rm = TRUE)
            ,AD_WEATHER      = sum(AD_WEATHER,    na.rm = TRUE)
            ,AD_DISRUPTION_ATC=sum(AD_DISRUPTION_ATC, na.rm = TRUE)
            ,AD_CAPACITY_ATC = sum(AD_CAPACITY_ATC, na.rm = TRUE)
            ,AD_STAFFING_ATC = sum(AD_STAFFING_ATC, na.rm = TRUE)
            ,AD_EVENTS       = sum(AD_EVENTS,     na.rm = TRUE)
            ) %>% ungroup() %>%
  tidyr::pivot_longer(cols = starts_with("AD_"), names_to = "REG_REASON", values_to = "DLY") %>%
  mutate(AVG_ARR_ATFM_DLY = DLY_APT_ARR_TOT / FLT_ARR_TOT
         ,AVG_ARR_ATFM_REG= DLY / FLT_ARR_TOT)


#############
filter_years <- atfm_pm %>% pull(YEAR) %>% unique()
button_list  <- lapply(1:length(filter_years), function(x){
  list(method = "restyle",
       args = list("transforms[0].value", filter_years[x]),
       label = filter_years[x])
})


button_type_list <-  list(
 # type = 'dropdown',
  type = 'buttons',
  bgcolor = '#c3c1e8',
 active = length(filter_years)-1,
 direction = 'right'
 , xref = "paper", x = 0.3, xanchor = 'left'
 , yref = "paper", y = 1.2, yanchor = "bottom",
#  pad = list('r'= 0, 't'= 10, 'b' = 10),   # adding xref, yref & without padding buttons stay fixed
  buttons = button_list
)
##########################

# set REG_REASON grouping and colours 
atfm_pm <- atfm_pm %>%
  mutate(REG_REASON = factor(REG_REASON, levels = atfm_grps, labels = atfm_lbl))

atfm_pm %>%
  plot_ly(x = ~MONTH_NUM, y = ~AVG_ARR_ATFM_REG
          #https://github.com/ropensci/plotly/issues/1502
        # define mapping variable for transform filter, i.e. cannot link directly to ~YEAR!!!
        , customdata=~YEAR
          , color = ~REG_REASON, colors = atfm_col
          , type = "bar"
          , transforms = list(
              list(
                type = 'filter',
                target = "customdata",
                operation = '=',
                value = "2020"
                  )
              ) # end transforms list
        ) %>%
  layout( barmode = "stack"
         ,hovermode = "x unified"
         ,xaxis = tick_yr_no_title
         ,yaxis=list(title="Average arrival ATFM delay [min/arr]"
                     ,titlefont = list(size = 11)
                     ,rangemode = 'tozero')
         ,showlegend = TRUE
         ,updatemenus = list( button_type_list )
         ) %>% 
config( displaylogo = FALSE
       ,modeBarButtonsToRemove = config_bar_remove_buttons)
```

## Row --------------------------------------------------------------------

### Daily Arrival ATFM Delay

```{r}
tmp <- params$atfm %>% group_by(FLT_DATE) %>%
  summarise( ARRS         = sum(FLT_ARR_1, na.rm = TRUE)
            ,TOT_ARR_ATFM = sum(DLY_APT_ARR_1, na.rm = TRUE)
            ,DLYD_ARRS    = sum(FLT_ARR_1_DLY, na.rm = TRUE)
            ,DLYS_ARRS_15 = sum(FLT_ARR_1_DLY_15, na.rm = TRUE)
            )

worst_day_last_year <- tmp %>%
  top_n(365, FLT_DATE) %>%
  filter(TOT_ARR_ATFM == max(TOT_ARR_ATFM, na.rm = TRUE))

worst_day_date <- worst_day_last_year$FLT_DATE
worst_day_dly  <- worst_day_last_year$TOT_ARR_ATFM
worst_day_avgATFMdly <- worst_day_last_year$TOT_ARR_ATFM / worst_day_last_year$ARRS

if(nrow(worst_day_last_year) >= 5){
  key_msg <- paste0(
    "<b>Many days with identical <br>share of Arrival ATFM Delay!<b>")
  worst_day_date <- floor_date(mean(worst_day_last_year$FLT_DATE))
  worst_day_dly  <- unique(worst_day_last_year$TOT_ARR_ATFM)
  
}else{
  key_msg <- paste0(
     "<b>Worst day in last 12 months: ", worst_day_date
    ,"<br>with total Arrival ATFM Delay: ", worst_day_dly,"min"
    ,"<br>(avg. Arrival ATFM Delay: ", round(worst_day_avgATFMdly,2), "min)</b>")
}

p <- tmp %>%
  plot_ly(x = ~FLT_DATE, y = ~TOT_ARR_ATFM
          , type = 'scatter', mode = 'lines'
          , line = list(shape = "hvh", width = 1)
          ) %>%
  add_annotations(text = key_msg
                  , x = worst_day_date, y = worst_day_dly
                  , showarrow = TRUE, ax = -50, ay = -50
                  , align = "right"
                  ) %>%
  layout(#title = "Daily Total Arrival ATFM Delay"
         #, margin = list(t = 75)  # increase margin to deconflict titel and buttons
         #, 
         xaxis = list( title = ""
                      ,rangeslider = list(type = "date")
                        )
        ,yaxis = list(title = "Arrival ATFM delay [min]"
                      ,titlefont = list(size = 11))
         ) %>% 
  config( displaylogo = FALSE
         ,modeBarButtonsToRemove = config_bar_remove_buttons)
p
```


### Share of ATFM Delay Current Year

```{r atfm-ytd}
current_year <- lubridate::year(Sys.time())
share_atfm <- atfm_pm %>% filter(YEAR == current_year) %>% 
  group_by(REG_REASON) %>%
  summarise( FLT_ARR_TOT = sum(FLT_ARR_TOT, na.rm = TRUE)
            ,DLY =         sum(DLY, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(DLY_TOT    = sum(DLY, na.rm = TRUE)
         ,DLY_SHARE = round(DLY / DLY_TOT,2) 
         ,LABELS = paste0(REG_REASON,"<br>", DLY_SHARE,"%")) %>%
  # surpress 0% !!
  filter(DLY_SHARE > 0)


#reg_rsn <- share_atfm$REG_RESON
#atfm_grps_pie <- atfm_grps[atfm_grps %in% reg_rsn]
#atfm_col_pie  <- atfm_col[atfm_grps %in% reg_rsn]

center_text <- paste0("<b>", current_year,"</b>")

share_atfm %>%
  plot_ly(labels = ~REG_REASON, values = ~DLY_SHARE #, color = atfm_col_pie
          ) %>%
    add_pie(hole = 0.4
            #,textposition = ifelse(atfm_pm$DLY_SHARE < .25,"outside","inside")
            ,textposition = "outside"
            ) %>%
  add_annotations( text = center_text, font = list(size = 18)
                  ,x = 0.5, y = 0.5, showarrow = FALSE) %>%
  config( displaylogo = FALSE
         ,modeBarButtonsToRemove = config_bar_remove_buttons)
```

# ASMA

## Row ------------------------------------------------------------------

### Annual ASMA

```{r ASMA-annual}
# annual bar chart
asma_pa <- params$asma %>% select(YEAR, TIME_ASMA_ADD_2, TIME_ASMA_UNIMP_2, FLT_ASMA_UNIMP_2 ) %>%
  group_by(YEAR) %>%
  summarise( TOT_ADD_ASMA_TIME = sum(TIME_ASMA_ADD_2,   na.rm = TRUE)
            ,TOT_UNIMP_TIME    = sum(TIME_ASMA_UNIMP_2, na.rm = TRUE)
            ,TOT_FLT           = sum(FLT_ASMA_UNIMP_2,  na.rm = TRUE)
  ) %>% ungroup %>%
  mutate( AVG_UNIMP_TIME        = TOT_UNIMP_TIME    / TOT_FLT
         ,AVG_ADD_ASMA_TIME     = TOT_ADD_ASMA_TIME / TOT_FLT) 

asma_pa <- asma_pa %>% 
  tidyr::pivot_longer(cols = c("AVG_UNIMP_TIME","AVG_ADD_ASMA_TIME")
                      ,names_to = "TYPE", values_to = "TIME" ) 

asma_pa <- asma_pa %>%
  mutate(TYPE = factor(TYPE, levels = c("AVG_UNIMP_TIME","AVG_ADD_ASMA_TIME")
                       ,labels = c("avg. reference time","avg. additional time")
                       )
         )
#%>%
#  mutate(COL_LBL = if_else(TYPE == "AVG_ADD_ASMA_TIME"
#                           , "avg. additional time", "avg. reference time"))

asma_pa %>%
  plot_ly(x=~YEAR, y=~TIME
          , type = "bar"
          , color = ~TYPE
          , showlegend = TRUE
          ) %>%
  #add_bars(x=~YEAR, y=~AVG_ADD_ASMA_TIME, type = "bar")%>%
  layout(barmode = "stack"
         , hovermode = "x unified"
         ,xaxis = list(title = "", type = "category")
         ,yaxis = list( title = "Average ASMA time [min/arr]"
                       ,titlefont = list(size = 11)
                       ,hoverformat = ".2f")
         ) %>%
  config( displaylogo = FALSE
         ,modeBarButtonsToRemove = config_bar_remove_buttons)

#%>%
#  add_annotations(
#    text = "example text in graphic annual variation"
#    ,xref = "paper",yref = "paper"
#    ,x = 0.1, y = 1.05
#    ,xanchor = "middle",yanchor = "top", showarrow = FALSE
#    ,font = list(size = 15))
#asma_pm <- asma %>% 
#  mutate(YEAR_MONTH = sprintf("%d-%02d", YEAR, MONTH_NUM))
```

### Monthly ASMA

```{r ASMA-monthly}
asma_pm <- params$asma %>%
  select(YEAR, MONTH_NUM, TIME_ASMA_ADD_2, TIME_ASMA_UNIMP_2, FLT_ASMA_UNIMP_2 ) %>%
  group_by(YEAR, MONTH_NUM) %>%
  summarise( TOT_ADD_ASMA_TIME = sum(TIME_ASMA_ADD_2,   na.rm = TRUE)
            ,TOT_UNIMP_TIME    = sum(TIME_ASMA_UNIMP_2, na.rm = TRUE)
            ,TOT_FLT           = sum(FLT_ASMA_UNIMP_2,  na.rm = TRUE)
  ) %>% ungroup %>%
  mutate( AVG_ADD_ASMA_TIME     = TOT_ADD_ASMA_TIME / TOT_FLT
         ,AVG_UNIMP_TIME        = TOT_UNIMP_TIME    / TOT_FLT) 

asma_pm <- asma_pm %>% 
  tidyr::pivot_longer(cols = c("AVG_UNIMP_TIME","AVG_ADD_ASMA_TIME")
                      ,names_to = "TYPE", values_to = "TIME" ) 

asma_pm <- asma_pm %>%
  mutate(TYPE = factor(TYPE
                       ,levels = c("AVG_UNIMP_TIME","AVG_ADD_ASMA_TIME")
                       ,labels = c("avg. reference time","avg. additional time")
                       )
         )
#############
filter_years <- asma_pm %>% pull(YEAR) %>% unique()
button_list  <- lapply(1:length(filter_years), function(x){
  list(method = "restyle",
       args = list("transforms[0].value", filter_years[x]),
       label = filter_years[x])
})

button_type_list <-  list(
 # type = 'dropdown',
  type = 'buttons',
  bgcolor = '#c3c1e8',
 active = length(filter_years)-1,
 direction = 'right'
 , xref = "paper", x = 0.3, xanchor = 'left'
 , yref = "paper", y = 1.2, yanchor = "bottom",
#  pad = list('r'= 0, 't'= 10, 'b' = 10),   # without padding buttons stay fixed
  buttons = button_list
)
##########################
 
asma_pm %>%
  plot_ly(x = ~MONTH_NUM, y = ~TIME 
          #https://github.com/ropensci/plotly/issues/1502
        # define mapping variable for transform filter, i.e. cannot link directly to ~YEAR!!!
        , customdata=~YEAR
          , color = ~TYPE
          , type = "bar"
          , transforms = list(
              list(
                type = 'filter',
                target = "customdata",
                operation = '=',
                value = "2020"
                  )
              ) # end transforms list
        ) %>%
  layout( barmode = "stack"
         ,hovermode = "x unified"
         ,xaxis = tick_yr_no_title
         ,yaxis=list( title="Average ASMA Time [min/arr]"
                     ,titlefont = list(size = 11)
                     , hoverformat = ".2f")
         ,showlegend = TRUE
         ,updatemenus = list( button_type_list )
         ) %>% 
  config( displaylogo = FALSE
         ,modeBarButtonsToRemove = config_bar_remove_buttons)

```

## Row --------------------------------------------------------------

### Monthly ASMA Trend (current Year)

```{r asma-trend}
tmp <- params$asma %>% 
  mutate( DATE_YM = paste0(YEAR,"-",MONTH_NUM)
         ,DATE_YM = lubridate::parse_date_time(DATE_YM, "ym")  # coerce date
         ,AVG_ADD_ASMA = TIME_ASMA_ADD_2 / FLT_ASMA_UNIMP_2
         )

p <- tmp %>%
  plot_ly(x = ~DATE_YM, y = ~AVG_ADD_ASMA
          , type = 'scatter', mode = 'lines'
          , line = list(shape = "hvh", width = 1)
          ) %>%
  layout( hoverformat = ".2f" 
         ,xaxis = list(title = ""
         , rangeselector = list(
        buttons = list(
          list(
            count = 3,
            label = "3 mo",
            step = "month",
            stepmode = "backward"),
          list(
            count = 6,
            label = "6 mo",
            step = "month",
            stepmode = "backward"),
          list(
            count = 1,
            label = "1 yr",
            step = "year",
            stepmode = "backward"),
          list(
            count = 1,
            label = "YTD",
            step = "year",
            stepmode = "todate"),
          list(step = "all"))),

      rangeslider = list(type = "date")
                        )
         , yaxis = list(title = "Additional average ASMA time [min/arr]"
                        ,titlefont = list(size = 11))
         ) %>% 
  config( displaylogo = FALSE
         ,modeBarButtonsToRemove = config_bar_remove_buttons)

p
```

# Taxi-Times

## Row -----------------------------------------------------------------------

### Avergage Taxi-Out Time

```{r txot-annual}
# annual bar chart
txot_pa <- params$txot %>% select(YEAR, TIME_TXO_ADD_2, TIME_TXO_UNIMP_2, FLT_TXO_UNIMP_2 ) %>%
  group_by(YEAR) %>%
  summarise( TOT_ADD_TXO_TIME  = sum(TIME_TXO_ADD_2,   na.rm = TRUE)
            ,TOT_UNIMP_TIME    = sum(TIME_TXO_UNIMP_2, na.rm = TRUE)
            ,TOT_FLT           = sum(FLT_TXO_UNIMP_2,  na.rm = TRUE)
  ) %>% ungroup %>%
  mutate( AVG_ADD_TXO_TIME     = TOT_ADD_TXO_TIME / TOT_FLT
         ,AVG_UNIMP_TIME       = TOT_UNIMP_TIME   / TOT_FLT)

txot_pa <- txot_pa %>% 
  tidyr::pivot_longer(cols = c("AVG_ADD_TXO_TIME","AVG_UNIMP_TIME")
                      ,names_to = "TYPE", values_to = "TIME" ) 

# coerce grouping - most right = top of bar
txot_pa <- txot_pa %>%
  mutate(TYPE = factor(TYPE
                       ,levels = c("AVG_UNIMP_TIME","AVG_ADD_TXO_TIME")
                       ,labels = c("avg. reference time","avg. additional time")
                       )
  )

g1 <- txot_pa %>%
  plotly::plot_ly(x=~YEAR, y=~TIME
          , type = "bar"
          , showlegend = TRUE
          , color=~TYPE
          ) %>%
  layout(barmode = "stack", hovermode = "x unified"
         , xaxis = list(title="")
         , yaxis = list(title="Average taxi-out time [min/dep]"
                        ,titlefont = list(size = 11)
                        ,hoverformat = ".2f")
         ) %>% 
  config( displaylogo = FALSE
         ,modeBarButtonsToRemove = config_bar_remove_buttons)

g1
```

<!-- TO-DO: add annotation plotly::add_annotations(
    text = "annual variation"
    ,xref = "paper",yref = "paper"
    ,x = 0.1, y = 1.05
    ,xanchor = "middle",yanchor = "top", showarrow = FALSE
    ,font = list(size = 15)) %>%
-->

### Monthly Average Additional Taxi-Out Time

```{r monthly-txot}
# monthly trend
txot_pm <- params$txot %>%
  select(YEAR, MONTH_NUM, TIME_TXO_ADD_2, TIME_TXO_UNIMP_2, FLT_TXO_UNIMP_2 ) %>%
  group_by(YEAR, MONTH_NUM) %>%
  summarise( TOT_ADD_TXO_TIME  = sum(TIME_TXO_ADD_2,   na.rm = TRUE)
            ,TOT_UNIMP_TIME    = sum(TIME_TXO_UNIMP_2, na.rm = TRUE)
            ,TOT_FLT           = sum(FLT_TXO_UNIMP_2,  na.rm = TRUE)
            ) %>% 
  ungroup %>%
  mutate( AVG_ADD_TXO_TIME     = TOT_ADD_TXO_TIME / TOT_FLT
         ,AVG_UNIMP_TIME       = TOT_UNIMP_TIME   / TOT_FLT
         )

txot_pm <- txot_pm %>% 
  tidyr::pivot_longer(cols = c("AVG_UNIMP_TIME","AVG_ADD_TXO_TIME")
                      ,names_to = "TYPE", values_to = "TIME" ) 
# coerce grouping
txot_pm <- txot_pm %>%
  mutate(TYPE = factor(TYPE
                       ,levels = c("AVG_UNIMP_TIME","AVG_ADD_TXO_TIME")
                       ,labels = c("avg. reference time","avg. additional time")
                       )
  )

#############
filter_years <- txot_pm %>% pull(YEAR) %>% unique()
button_list  <- lapply(1:length(filter_years), function(x){
  list(method = "restyle",
       args = list("transforms[0].value", filter_years[x]),
       label = filter_years[x])
})

button_type_list <-  list(
 # type = 'dropdown',
  type = 'buttons',
  bgcolor = '#c3c1e8',
 active = length(filter_years)-1,
 direction = 'right'
 , xref = "paper", x = 0.3, xanchor = 'left'
 , yref = "paper", y = 1.2, yanchor = "bottom",
#  pad = list('r'= 0, 't'= 10, 'b' = 10),   # without padding buttons stay fixed
  buttons = button_list
)
##########################
 
txot_pm %>%
  plot_ly(x = ~MONTH_NUM, y = ~TIME 
          #https://github.com/ropensci/plotly/issues/1502
        # define mapping variable for transform filter, i.e. cannot link directly to ~YEAR!!!
        , customdata=~YEAR
          , color = ~TYPE
          , type = "bar"
          , transforms = list(
              list(
                type = 'filter',
                target = "customdata",
                operation = '=',
                value = "2020"
                  )
              ) # end transforms list
        ) %>%
  layout( barmode = "stack", hovermode = "x unified"
         ,xaxis = tick_yr_no_title
         ,yaxis=list( title="Average taxi-out time [min/arr]"
                     ,titlefont = list(size = 11)
                     ,hoverformat = ".2f")
         ,showlegend = TRUE
         ,updatemenus = list( button_type_list )
         ) %>% 
  config( displaylogo = FALSE
         ,modeBarButtonsToRemove = config_bar_remove_buttons)

```

<!-- 
### next next stuff

Looks like something for the header
%>% 
  add_annotations(
    text = "monthly variation per year"
    ,xref = "paper",yref = "paper"
    ,x = 0.5, y = 1.05
    ,xanchor = "middle",yanchor = "top", showarrow = FALSE
    ,font = list(size = 15))


  
## Row --------------------------------------------------------------------

### what goes here?

THink about adding something here.
E.g. most frequently used stands, txot by (most frequent) airspace users

# Taxi-In

---------------------------------    -->

## Row -------------------------------------------------------------------

### Avergage Taxi-In Time

```{r txit}
# annual bar chart
txit_pa <- params$txit %>%
  group_by(YEAR) %>% 
  summarise(# TOT_A_TXIT   = sum(TOT_A_TXIT)
             TOT_REF      = sum(TOT_REF     , na.rm = TRUE)
            ,TOT_ADD_TXIT = sum(TOT_ADD_TXIT, na.rm = TRUE)
            ,TOT_N        = sum(N_SMPL      , na.rm = TRUE)
            ) %>% 
  ungroup() %>% 
  mutate(# AVG_A_TXIT   = TOT_A_TXIT   / TOT_N
          AVG_REF      = TOT_REF      / TOT_N
         ,AVG_ADD_TXIT = TOT_ADD_TXIT / TOT_N)

txit_pa <- txit_pa %>%
  tidyr::pivot_longer( cols = c("AVG_ADD_TXIT","AVG_REF")
                      ,names_to = "TYPE", values_to = "TIME" ) 

# coerce Grouping
txit_pa <- txit_pa %>%
  mutate(TYPE = factor(TYPE
                       ,levels = c("AVG_REF","AVG_ADD_TXIT")
                       ,labels = c("avg. reference time","avg. additional time")
                       )
         )

txit_pa %>%
  plotly::plot_ly(x=~YEAR, y=~TIME
          , type = "bar"
          , showlegend = TRUE
          , color=~TYPE
          ) %>%
  layout(barmode = "stack", hovermode = "x unified"
         , xaxis = list(title="")
         , yaxis = list(title="average taxi-in time [min/arr]"
                        ,titlefont = list(size=11)
                        ,hoverformat = ".2f")
         )%>% 
  config( displaylogo = FALSE
         ,modeBarButtonsToRemove = config_bar_remove_buttons)
```

<!-- TODO: plotly::add_annotations(
    text = "annual variation"
    ,xref = "paper",yref = "paper"
    ,x = 0.1, y = 1.05
    ,xanchor = "middle",yanchor = "top", showarrow = FALSE
    ,font = list(size = 15)) %>%
-->    

### Monthly Average Additional Taxi-In Time

```{r monthly-txit}
# monthly trend
txit_pm <- params$txit %>%
# select(YEAR, MONTH_NUM, TOT_A_TXIT, TOT_REF, TOT_ADD_TXIT, N_SMPL) %>%
# trim to barebone
  select(YEAR, MONTH_NUM, TOT_REF, TOT_ADD_TXIT, N_SMPL) %>%
  group_by(YEAR, MONTH_NUM) %>% 
  summarise(# TOT_A_TXIT   = sum(TOT_A_TXIT)
             TOT_REF      = sum(TOT_REF)
            ,TOT_ADD_TXIT = sum(TOT_ADD_TXIT)
            ,TOT_N        = sum(N_SMPL)) %>% 
  ungroup() %>% 
  mutate( AVG_REF      = TOT_REF      / TOT_N
         ,AVG_ADD_TXIT = TOT_ADD_TXIT / TOT_N)


txit_pm <- txit_pm %>% 
  tidyr::pivot_longer(cols = c("AVG_REF","AVG_ADD_TXIT")
                      ,names_to = "TYPE", values_to = "TIME" )

txit_pm <- txit_pm %>%
  mutate(TYPE = factor(TYPE
                       ,levels = c("AVG_REF","AVG_ADD_TXIT")
                       ,labels = c("avg. reference time","avg. additional time")
                       )
         )

#############
filter_years <- txot_pm %>% pull(YEAR) %>% unique()
button_list  <- lapply(1:length(filter_years), function(x){
  list(method = "restyle",
       args = list("transforms[0].value", filter_years[x]),
       label = filter_years[x])
})

button_type_list <-  list(
 # type = 'dropdown',
  type = 'buttons',
  bgcolor = '#c3c1e8',
 active = length(filter_years)-1,
 direction = 'right'
 , xref = "paper", x = 0.3, xanchor = 'left'
 , yref = "paper", y = 1.2, yanchor = "bottom",
#  pad = list('r'= 0, 't'= 10, 'b' = 10),   # without padding buttons stay fixed
  buttons = button_list
)
##########################
 
txit_pm %>%
  plot_ly(x = ~MONTH_NUM, y = ~TIME 
          #https://github.com/ropensci/plotly/issues/1502
        # define mapping variable for transform filter, i.e. cannot link directly to ~YEAR!!!
        , customdata=~YEAR
          , color = ~TYPE
          , type = "bar"
          , transforms = list(
              list(
                type = 'filter',
                target = "customdata",
                operation = '=',
                value = "2020"
                  )
              ) # end transforms list
        ) %>%
  layout( barmode = "stack", hovermode = "x unified"
         ,xaxis = tick_yr_no_title
         ,yaxis=list( title="Average taxi-in time [min/arr]"
                     ,titlefont = list(size = 11)
                     ,hoverformat = ".2f")
         ,showlegend = TRUE
         ,updatemenus = list( button_type_list )
         ) %>% 
  config( displaylogo = FALSE
         ,modeBarButtonsToRemove = config_bar_remove_buttons)
```


# Pre-Dep Delay

## Row -------------------------------------------------------

### Annual Pre-Departure Delay (as reported by airports)

```{r pre-dep-dly-pa}
# annual bar chart
pddly_pa <- params$pddly %>% 
  select(YEAR, TOTAL_DLY_89, TOTAL_DLY_999 , TOTAL_DLY_ZZZ, TOTAL_DLY_OTHER
         , TOTAL_UN_RPTED_DLY, TOTAL_OV_RPTED_DLY) %>%
  group_by(YEAR) %>%
  summarise( TOT_DLY_89        = sum(TOTAL_DLY_89,   na.rm = TRUE)
            ,TOT_DLY_999       = sum(TOTAL_DLY_999,  na.rm = TRUE)
            ,TOT_DLY_ZZZ       = sum(TOTAL_DLY_ZZZ,  na.rm = TRUE)
            ,TOT_DLY_OTHER     = sum(TOTAL_DLY_OTHER,na.rm = TRUE)
            ,TOT_DLY_UNREPORTED= sum(TOTAL_UN_RPTED_DLY, na.rm = TRUE)
            ,TOT_DLY_OVREPORTED= sum(TOTAL_OV_RPTED_DLY, na.rm = TRUE)
  ) %>% ungroup %>%

## grouping for v1 ------------------------------
## discussion Sara & Rainer: do not show overreported
  mutate(
    TOT_DLY_UNID = TOT_DLY_999 + TOT_DLY_ZZZ + TOT_DLY_UNREPORTED 
  ) %>%
  select(YEAR, TOT_DLY_89, TOT_DLY_OTHER, TOT_DLY_UNID)  %>%
  tidyr::pivot_longer(cols = starts_with("TOT_DLY_") , names_to = "DLY_CAT", values_to = "DLY_DUR")

## order DLY_CAT and ensure label naming for legend
pddly_pa$DLY_CAT <- factor(pddly_pa$DLY_CAT
                           ,levels=c("TOT_DLY_UNID", "TOT_DLY_OTHER", "TOT_DLY_89")
                           ,labels=c("unidentified", "other reasons", "ATC pre-departure <br>delay (code 89)"))

g1 <- pddly_pa %>%
  plot_ly(x=~YEAR, y=~DLY_DUR, type="bar", color=~DLY_CAT, legendgroup=~DLY_CAT) %>%
  layout( barmode = "stack"
         ,hovermode = "x unified" 
         ,xaxis = list(title = "")
         ,yaxis = list( title = "Pre-departure delay [min]"
                       ,titlefont = list(size = 11)
                       )
         ) %>% 
  config( displaylogo = FALSE
         ,modeBarButtonsToRemove = config_bar_remove_buttons)

g1
```

### Monthly Pre-departure Delay (as reported by airports)

```{r}
pddly_pm <- params$pddly %>%
  select(YEAR, MONTH_NUM, TOTAL_DLY_89, TOTAL_DLY_999 , TOTAL_DLY_ZZZ, TOTAL_DLY_OTHER
         , TOTAL_UN_RPTED_DLY, TOTAL_OV_RPTED_DLY) %>%
  group_by(YEAR, MONTH_NUM) %>%
  summarise( TOT_DLY_89        = sum(TOTAL_DLY_89,   na.rm = TRUE)
            ,TOT_DLY_999       = sum(TOTAL_DLY_999,  na.rm = TRUE)
            ,TOT_DLY_ZZZ       = sum(TOTAL_DLY_ZZZ,  na.rm = TRUE)
            ,TOT_DLY_OTHER     = sum(TOTAL_DLY_OTHER,na.rm = TRUE)
            ,TOT_DLY_UNREPORTED= sum(TOTAL_UN_RPTED_DLY, na.rm = TRUE)
            ,TOT_DLY_OVREPORTED= sum(TOTAL_OV_RPTED_DLY, na.rm = TRUE)
  ) %>% ungroup %>%
  ## grouping for v1 ------------------------
  mutate(
    TOT_DLY_UNID = TOT_DLY_999 + TOT_DLY_ZZZ + TOT_DLY_UNREPORTED
  ) %>%
  select(YEAR, MONTH_NUM, TOT_DLY_89, TOT_DLY_OTHER, TOT_DLY_UNID) %>%
  tidyr::pivot_longer(cols = starts_with("TOT_DLY_") , names_to = "DLY_CAT", values_to = "DLY_DUR")

## order DLY_CAT and ensure label naming for legend
pddly_pm$DLY_CAT <- factor(pddly_pm$DLY_CAT
                           ,levels = c("TOT_DLY_UNID", "TOT_DLY_OTHER", "TOT_DLY_89")
                           ,labels = c("unidentified", "other reasons", "ATC pre-departure <br> delay (code 89)"))

button_type_list <-  list(
  buttons = button_list
 , type = 'buttons' #,type = 'dropdown'
 , bgcolor = '#c3c1e8'
 , active = length(filter_years)-1
 , direction = 'right'
 # position of button list
 , xref = "paper", x = 0.3, xanchor = 'left'
 , yref = "paper", y = 1.2, yanchor = "bottom"
 
)
##########################
 
pddly_pm %>%
  plot_ly(x = ~MONTH_NUM, y = ~DLY_DUR
          #https://github.com/ropensci/plotly/issues/1502
        # define mapping variable for transform filter, i.e. cannot link directly to ~YEAR!!!
        , customdata=~YEAR
          , color = ~DLY_CAT
          , type = "bar"
          , transforms = list(
              list(
                type = 'filter',
                target = "customdata",
                operation = '=',
                value = "2020"
                  )
              ) # end transforms list
        ) %>%
  layout( barmode = "stack"
         ,xaxis = tick_yr_no_title
         ,yaxis=list( title="Pre-departure delay [min]"
                     ,titlefont = list(size = 11)
                     )
         ,showlegend = TRUE
         ,updatemenus = list( button_type_list )
         ) %>% 
  config( displaylogo = FALSE
         ,modeBarButtonsToRemove = config_bar_remove_buttons)
```


## Row -----------------------------------------------------------

### Monthly Pre-Departure Delay Trend

```{r}
tmp <- pddly_pm %>%
  mutate( DATE_YM = paste0(YEAR,"-",MONTH_NUM)
         ,DATE_YM = lubridate::parse_date_time(DATE_YM, "ym")  # coerce date
        # ,AVG_ADD_ASMA = TIME_ASMA_ADD_2 / FLT_ASMA_UNIMP_2
         )
  
  
p <- tmp %>%
  plot_ly() %>%
  add_bars(x = ~DATE_YM, y = ~DLY_DUR
          #, type = 'scatter', mode = 'lines'
          #, line = list(shape = "hvh", width = 1)
          , color = ~DLY_CAT
          ) %>%
  layout(barmode = "stack"
         # xaxis and rangeselector
         ,xaxis = list(title = ""
         , rangeselector = list(
        buttons = list(
          list(
            count = 3,
            label = "3 mo",
            step = "month",
            stepmode = "backward"),
          list(
            count = 6,
            label = "6 mo",
            step = "month",
            stepmode = "backward"),
          list(
            count = 1,
            label = "1 yr",
            step = "year",
            stepmode = "backward"),
          list(
            count = 1,
            label = "YTD",
            step = "year",
            stepmode = "todate"),
          list(step = "all"))),

      rangeslider = list(type = "date")
                        )
         , yaxis = list( title = "Pre-departure delay [min]"
                        ,titlefont = list(size = 11)
                        )
         ) %>% 
  config( displaylogo = FALSE
         ,modeBarButtonsToRemove = config_bar_remove_buttons)
p
```

<!-- DEACTIVATED

### Pre-Departure Delay {data-width=350}

```{}
knitr::include_graphics("./figures/atc_pre-departure_delay.png")
```

### Pre-Departure Delay reporting

Airports report pre-departue delay on a flight by flight basis. 
To address incomplete or inconsistent delay codes reported  by airspace user to the airport operator, the airport operator may default to so-called ambiguity-codes.
Ambiguity codes and other codes are summed to **unidentified delay**.

--> 

### Average ATC Pre-Departure Delay

```{r pre-dep-indicator}
predepdly_pm <- params$pddly %>%
  select(YEAR, MONTH_NUM, APT_FLT_DEP
         , TOTAL_DLY_89, TOTAL_DLY_999 , TOTAL_DLY_ZZZ, TOTAL_DLY_OTHER
         , TOTAL_UN_RPTED_DLY, TOTAL_OV_RPTED_DLY) %>%
  group_by(YEAR, MONTH_NUM) %>%
  summarise( TOT_FLT_DEP       = sum(APT_FLT_DEP,    na.rm = TRUE)
            ,TOT_DLY_89        = sum(TOTAL_DLY_89,   na.rm = TRUE)
            ,TOT_DLY_999       = sum(TOTAL_DLY_999,  na.rm = TRUE)
            ,TOT_DLY_ZZZ       = sum(TOTAL_DLY_ZZZ,  na.rm = TRUE)
            ,TOT_DLY_OTHER     = sum(TOTAL_DLY_OTHER,na.rm = TRUE)
            ,TOT_DLY_UNREPORTED= sum(TOTAL_UN_RPTED_DLY, na.rm = TRUE)
            ,TOT_DLY_OVREPORTED= sum(TOTAL_OV_RPTED_DLY, na.rm = TRUE)
  ) %>% ungroup %>%
  ## grouping for v1 ------------------------
  mutate(
     TOT_DLY_UNID  = TOT_DLY_999 + TOT_DLY_ZZZ + TOT_DLY_OTHER + TOT_DLY_UNREPORTED
    ,AVG_PREDEP_DLY= TOT_DLY_89 / TOT_FLT_DEP
  ) %>%
  select(YEAR, MONTH_NUM, AVG_PREDEP_DLY) 

################################################
button_type_list <-  list(
  buttons = button_list
 , type = 'buttons' # ,type = 'dropdown'
 , bgcolor = '#c3c1e8'
 , active = length(filter_years)-1
 , direction = 'right'
 # position of button list
 , xref = "paper", x = 0.3, xanchor = 'left'
 , yref = "paper", y = 1.2, yanchor = "bottom"
 
)
##########################
 
predepdly_pm %>%
  plot_ly(x = ~MONTH_NUM, y = ~AVG_PREDEP_DLY
          #https://github.com/ropensci/plotly/issues/1502
        # define mapping variable for transform filter, i.e. cannot link directly to ~YEAR!!!
        , customdata=~YEAR
         # , color = ~DLY_CAT
          , type = "bar"
          , transforms = list(
              list(
                type = 'filter',
                target = "customdata",
                operation = '=',
                value = "2020"
                  )
              ) # end transforms list
        ) %>%
  layout( barmode = "stack"
         ,xaxis = tick_yr_no_title
         ,yaxis=list( title="Avg. ATC pre-departure delay [min/dep]"
                     ,titlefont = list(size = 11)
                     ,hoverformat = ".2f")
         ,showlegend = FALSE
         ,updatemenus = list( button_type_list )
         ) %>%
  config( displaylogo = FALSE
         ,modeBarButtonsToRemove = config_bar_remove_buttons)
```

# Turnaround

## Row ----------------------------------------------------------

### Annual Average Actual Turnaround Times

```{r annual_turn_time}
turn_pa <- params$turn %>%  
     select(YEAR, AC_CLASS, AVG_ATTT) %>% 
     filter(AC_CLASS %in% c("H", "MJ", "MT") ) %>%
     group_by(YEAR, AC_CLASS) %>% 
     summarise(AVG_ATTT = mean(AVG_ATTT), .groups = "drop") %>%
     pivot_wider(names_from = "AC_CLASS", values_from = AVG_ATTT)

#if(params$icao %in% c("EDDR","EGLC")){
#  g1 <- turn_pa %>%
#  plot_ly(x = ~YEAR) %>%
#  add_bars(y = ~MJ, name = "Medium Jet") %>%
#  add_bars(y = ~MT, name = "Medium Prop")
#}else{
#  g1 <- turn_pa %>%
#  plot_ly(x = ~YEAR) %>%
#  add_bars(y = ~H,  name = "Heavy") %>%
#  add_bars(y = ~MJ, name = "Medium Jet") %>%
#  add_bars(y = ~MT, name = "Medium Prop")
#}

# define the possible aircraft class names
nice_names <- tribble(~CLASS, ~NAME
                       ,"H"  , "Heavy"
                       ,"MJ" , "Medium Jet"
                       ,"MT" , "Medium Turboprop"
                       ,"LJ" , "Light Jet"
                       ,"LT" , "Light Turboprop"
                       ,"LP" , "Light Piston")

# check for aircraft classes in data
col_names <- colnames(turn_pa)[-1]  # remove first col = YEAR (no ac-class!)

# setup plot
g1 <- turn_pa %>% plot_ly(x = ~YEAR)

# iterate over all aircraft class columns
for(my_class in col_names){
  g1 <- g1 %>% 
    add_bars( y    = as.formula(paste0("~`", CLASS, "`"))
             ,name = nice_names$NAME[nice_names$CLASS == my_class])
}

# pimp the vis
g1 <- g1 %>%
  layout( xaxis = list(title = "", type = "category")
         ,yaxis = list(title = "Average turnaround time [min]"
                       ,titlefont = list(size = 11)
                       ,hoverformat = ".2f")
         ) %>%
  config( displaylogo = FALSE
         ,modeBarButtonsToRemove = config_bar_remove_buttons)
g1
```


### Monthly Turnaround Time

```{r monthly_turn_time}
turn_pm <- params$turn %>% 
    select(YEAR, MONTH, AC_CLASS, AVG_ATTT, AVG_STTT) %>% 
    filter(AC_CLASS %in% c("H", "MJ", "MT") ) %>%
    group_by(YEAR, MONTH, AC_CLASS) %>% 
    summarise(AVG_ATTT = mean(AVG_ATTT), AVG_STTT = mean(AVG_STTT)) %>%
    ungroup() %>%
    mutate( LBL_ACTUAL = paste0("actual turnaround ",   AC_CLASS)
           ,LBL_SCHED  = paste0("scheduled turnaround ",AC_CLASS)
    )

################################################
button_type_list <-  list(
  buttons = button_list
 , type = 'buttons' # ,type = 'dropdown'
 , bgcolor = '#c3c1e8'
 , active = length(filter_years)-1
 , direction = 'right'
 # position of button list
 , xref = "paper", x = 0.3, xanchor = 'left'
 , yref = "paper", y = 1.2, yanchor = "bottom"
 
)
##########################

turn_pm %>% 
  plot_ly() %>% 
  add_lines(x=~MONTH, y=~AVG_ATTT, color =~AC_CLASS
            , name = ~LBL_ACTUAL       # "actual"
# https://github.com/ropensci/plotly/issues/1502
# define mapping variable for transform filter, i.e. cannot
# link directly to ~YEAR!!!
          ,customdata=~YEAR
          # given with add_lines, type = "scatter" ## "bar"
          , transforms = list(
              list(
                type = 'filter',
                target = "customdata",
                operation = '=',
                value = "2020"
                  )
              ) # end transforms list)
          ,text = ~AC_CLASS
          , hovertemplate = paste0( "Class: %{text}"
                                   ,"<br>Month: %{x}"
                                   ,"<br>Avg. Turn: %{y:.2f}min")
          ,legendgroup = ~AC_CLASS
          ,showlegend = TRUE
         ) %>% 
  add_lines( x=~MONTH, y=~AVG_STTT, color =~AC_CLASS
            , name = ~LBL_SCHED   # "scheduled"
            , line = list(dash = 'dash')
            #https://github.com/ropensci/plotly/issues/1502
          #define mapping variable for transform filter, i.e. cannot link directly to ~YEAR!!!
          ,customdata=~YEAR
         # , type = "line" ## "bar"
          , transforms = list(
              list(
                type = 'filter',
                target = "customdata",
                operation = '=',
                value = "2020"
                  )
              ) # end transforms list)
         ,text = ~AC_CLASS
          , hovertemplate = paste0( "Class: %{text}"
                                   ,"<br>Month: %{x}"
                                   ,"<br>Avg. Turn: %{y:.2f}min")
         ,showlegend = TRUE
         ,legendgroup = ~AC_CLASS
         ) %>%
  layout( updatemenus = list( button_type_list )
         ,hovermode = "x unified"  
         ,xaxis = tick_yr_no_title 
         ,yaxis = list(title = "Average monthly turn times [min]"
                      ,titlefont = list(size = 11))
         ) %>%
  config( displaylogo = FALSE
         ,modeBarButtonsToRemove = config_bar_remove_buttons)
```



## Row ---------------------------------------------------------------

### Variation of Annual Actual Turnaround Times

```{r}
turn_pm %>%
  plot_ly(x = ~YEAR, y = ~AVG_ATTT, color = ~AC_CLASS, type = "box") %>%
  layout( boxmode = "group"   # save to ignore warning message
         ,xaxis = list(title = "")
         ,yaxis = list( title = "Average actual turnaround time [min]"
                       ,titlefont = list(size = 11)
                       ,hoverformat = ".2f")
         ) %>%
  config( displaylogo = FALSE
         ,modeBarButtonsToRemove = config_bar_remove_buttons)
```


<!--
### Available Turn-Times

add chart with available turnaround times

-->

# About

## Row ------------------------------------------------------------------

### Powered by {data-height=100}

```{r, out.width="40%", fig.pos="float"}
knitr::include_graphics("./figures/ECTRL-logo.svg")
```

### About this Dashboard

This data is published by the EUROCONTROL Performance Review Unit (PRU) in the interest of the exchange of information. 
It may be copied in whole or in part providing that this copyright notice © and disclaimer are included. 
The information may not be modified without prior written permission from the EUROCONTROL Performance Review Unit.
The information does not necessarily reflect the official views or policy of EUROCONTROL, which makes no warranty, either implied or expressed, for the information contained in this document, including its accuracy, completeness or usefulness.
Every effort has been made to ensure that the information and analysis contained on this website are as accurate and complete as possible. Despite these precautions, should you find any errors or inconsistencies or if you have any questions then please contact us at: Performance Review Unit (PRU-Support@eurocontrol.int).

### About Performance Review Unit

The PRU is responsible for monitoring and reviewing the performance of the Pan-European ANS system across a number of key performance areas.
As part of the EUROCONTROL Agency, the PRU supports the independent Performance Review Commission (PRC) in running the EUROCONTROL Performance Review System and executing the associated PRC work programme with the appropriate level of independence.
The PRU also provides support to the European Commission (EC) on the SES Performance and Charging Schemes.
In performing its tasks, the PRU maintains transparent working arrangements with service providers, airspace user organisations and the industry.
Although the PRU is independent, it is administratively reporting to the Directorate European Civil-Military Aviation (DECMA).
For feedback or questions please contact us at: Performance Review Unit (PRU-Support@eurocontrol.int).

## Row ------------------------------------------------------------------

### Data and Methodolgy

**Data and Methodology**   

IFR traffic data and ATFM delay related data is extracted from the Network Manager.    
All other airport related data is collected through the Airport Operator Data Flow (APDF). Under the APDF airports are required to report flight-by-flight data on a monthly basis. The data is reported during the month following the month of operations. Thus, typically, APDF data becomes available the 2nd month following the month of operation.    

**Data and metrics are shown based on availability at the moment of publication**    

*	traffic data comprises all IFR flight plans for the airport
*	ATFM delay data captures the arrival ATFM delay triggered by constraints at the airport.
*	ATFM delays are grouped according to the regulation reason as described in https://ansperformance.eu/definition/atfm-delay-codes/
*	additional ASMA time measures the difference between an observed travel time elapsing from entering the 40NM radius around the airport to landing. This time is compared against a reference time to the respective entry sector, aircraft type, and landing runway.
*	in analogy, additional taxi-times are measured for the taxi-out and taxi-in phase. The observed taxi times are compared with a respective reference time. The referncereference time considers the parking position and runway used by the departure/arrival.
*	pre-dearturedeparture delay provides for the airspace user reported delay reasoning in case of departures blocking off late. Delay codes have to be provided for delays >= 4 minutes. Most Aairports per se do not validate these delay codes, however, effort is underway to ensure appropriateness of the reported delay codes.
*	turnaround shows the time elapsing between an aircraft blocking in and blocking off for the next flight.

<!--
* punctuality is measured for the arrival and departure phase. The delay is expressed as the difference between the actual and scheduled off-block (i.e. departure) or in-block (i.e. arrival).
-->











